{% extends "base.html" %}

{% block title %}Status do Sistema - Painel de Comando{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Status do Sistema</h2>
  <small class="text-muted">Atualizado: <span id="status-updated-at">-</span></small>
  </div>

<div class="row g-3">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body d-flex align-items-center gap-3">
        <div id="st-gmail-indicator" class="fs-5">•</div>
        <div>
          <div class="fw-semibold">Gmail API</div>
          <small id="st-gmail-text" class="text-muted">Verificando...</small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body d-flex align-items-center gap-3">
        <div id="st-sheets-indicator" class="fs-5">•</div>
        <div>
          <div class="fw-semibold">Sheets API</div>
          <small id="st-sheets-text" class="text-muted">Verificando...</small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body d-flex align-items-center gap-3">
        <div id="st-drive-indicator" class="fs-5">•</div>
        <div>
          <div class="fw-semibold">Drive API</div>
          <small id="st-drive-text" class="text-muted">Verificando...</small>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let statusTimer = null;

function colorIndicator(el, ok) {
  if (!el) return;
  el.style.color = ok ? '#198754' : '#dc3545';
}

function setText(el, ok) {
  if (!el) return;
  el.textContent = ok ? 'Funcionando' : 'Erro';
  el.className = ok ? 'text-success' : 'text-danger';
}

function updateClock() {
  const el = document.getElementById('status-updated-at');
  if (el) el.textContent = new Date().toLocaleString('pt-BR', { hour12: false });
}

function fetchStatus() {
  fetch('/api/status')
    .then(r => r.json())
    .then(data => {
      const apis = data.apis || {};
      colorIndicator(document.getElementById('st-gmail-indicator'), !!apis.gmail);
      colorIndicator(document.getElementById('st-sheets-indicator'), !!apis.sheets);
      colorIndicator(document.getElementById('st-drive-indicator'), !!apis.drive);

      setText(document.getElementById('st-gmail-text'), !!apis.gmail);
      setText(document.getElementById('st-sheets-text'), !!apis.sheets);
      setText(document.getElementById('st-drive-text'), !!apis.drive);

      updateClock();
    })
    .catch(() => {
      ['st-gmail','st-sheets','st-drive'].forEach(prefix => {
        colorIndicator(document.getElementById(prefix + '-indicator'), false);
        setText(document.getElementById(prefix + '-text'), false);
      });
      updateClock();
    });
}

document.addEventListener('DOMContentLoaded', function () {
  fetchStatus();
  statusTimer = setInterval(fetchStatus, 5000);
});

window.addEventListener('beforeunload', function(){
  if (statusTimer) clearInterval(statusTimer);
});
</script>
{% endblock %}

