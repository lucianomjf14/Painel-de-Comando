{% extends "base.html" %}

{% block title %}Gmail - Painel de Comando{% endblock %}

{% block extra_css %}
<style>
    .message-list tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .message-list tbody tr td {
        padding: 0.35rem 0.6rem;
        vertical-align: middle;
        border-top: 1px solid rgba(32, 33, 36, 0.05);
    }
    .message-list tbody tr:hover {
        background-color: rgba(241, 243, 244, 0.8);
    }
    .message-list tbody tr.selected {
        background-color: rgba(66, 133, 244, 0.12);
    }
    .message-list tbody tr.fw-bold {
        font-weight: 600 !important;
    }
    .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.8rem;
    }
    .label-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.1rem 0.45rem;
        border-radius: 999px;
        font-size: 0.68rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        background: #e8eaed;
        color: #202124;
        white-space: nowrap;
    }
    .bulk-actions-bar {
        display: none;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(32, 33, 36, 0.08);
        background: rgba(248, 249, 250, 0.9);
        box-shadow: 0 1px 3px rgba(60, 64, 67, 0.1);
        flex-wrap: wrap;
    }
    .bulk-actions-bar strong {
        font-weight: 700;
    }
    .gmail-stat-card {
        border-radius: 0.9rem;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
    }
    .gmail-stat-card .card-body {
        padding: 0.85rem 1rem;
    }
    .gmail-stat-card .metric-value {
        font-size: 1.6rem;
        font-weight: 700;
        line-height: 1.1;
        margin-bottom: 0.15rem;
    }
    .gmail-stat-card .metric-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 0;
    }
    .gmail-stat-card .metric-icon {
        font-size: 1.65rem;
        opacity: 0.9;
    }
    @media (max-width: 991.98px) {
        .gmail-stat-card .card-body {
            padding: 0.75rem;
        }
        .gmail-stat-card .metric-value {
            font-size: 1.4rem;
        }
    }
    .thread-meta {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        flex-wrap: wrap;
    }
    .thread-sender {
        font-size: 0.92rem;
        color: #202124;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 220px;
        display: inline-block;
    }
    .thread-sender.unread {
        font-weight: 600;
    }
    .thread-subject {
        color: #202124;
        font-size: 0.92rem;
    }
    .thread-subject.unread {
        font-weight: 600;
    }
    .thread-snippet {
        color: #5f6368;
        font-size: 0.82rem;
        margin-left: 0.45rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 460px;
    }
    .thread-labels {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        margin-left: 0.45rem;
        flex-wrap: wrap;
    }
    .thread-date {
        font-size: 0.8rem;
        font-weight: 500;
        color: #3c4043;
        white-space: nowrap;
    }
    @media (max-width: 1199.98px) {
        .thread-sender {
            max-width: 160px;
        }
        .thread-snippet {
            max-width: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Gmail</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="refreshMessages()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Atualizar
                </button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sendEmailModal">
                    <i class="fas fa-paper-plane me-1"></i>
                    Enviar Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-danger text-white gmail-stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="metric-value" id="unread-count">-</div>
                        <p class="metric-label">Não Lidas</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-envelope metric-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white gmail-stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="metric-value" id="total-messages">-</div>
                        <p class="metric-label">Total</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-inbox metric-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white gmail-stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="metric-value" id="labels-count">-</div>
                        <p class="metric-label">Labels</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tags metric-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card gmail-stat-card" id="sent-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="metric-value" id="sent-count">-</div>
                        <p class="metric-label text-muted">Enviados</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-paper-plane metric-icon text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Filters -->
<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" data-filter-key="all" onclick="setQuickFilter('all')" id="filter-all">
                <i class="fas fa-inbox me-1"></i>Todas
            </button>
            <button type="button" class="btn btn-outline-danger active" data-filter-key="unread" onclick="setQuickFilter('unread')" id="filter-unread">
                <i class="fas fa-envelope me-1"></i>Não Lidas
            </button>
            <button type="button" class="btn btn-outline-warning" data-filter-key="starred" onclick="setQuickFilter('starred')" id="filter-starred">
                <i class="fas fa-star me-1"></i>Com Estrela
            </button>
            <button type="button" class="btn btn-outline-success" data-filter-key="important" onclick="setQuickFilter('important')" id="filter-important">
                <i class="fas fa-exclamation-circle me-1"></i>Importantes
            </button>
            <button type="button" class="btn btn-outline-info" data-filter-key="sent" onclick="setQuickFilter('sent')" id="filter-sent">
                <i class="fas fa-paper-plane me-1"></i>Enviadas
            </button>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="input-group">
            <input type="text" class="form-control" id="search-query" placeholder="Buscar mensagens (ex: from:exemplo@gmail.com subject:reunião)">
            <button class="btn btn-outline-primary" onclick="searchMessages()">
                <i class="fas fa-search"></i>
            </button>
            <button class="btn btn-outline-secondary" onclick="clearSearch()" title="Limpar busca">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="col-md-4">
        <select class="form-select" id="max-results" onchange="refreshMessages()">
            <option value="10">10 mensagens</option>
            <option value="25" selected>25 mensagens</option>
            <option value="50">50 mensagens</option>
            <option value="100">100 mensagens</option>
        </select>
    </div>
</div>

<!-- Messages Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Mensagens
                </h5>
            </div>
            <div class="card-body">
                <div id="bulk-actions" class="bulk-actions-bar mb-3">
                    <div>
                        <span><strong id="bulk-count">0</strong> selecionadas</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="bulkMarkRead()">
                            <i class="fas fa-envelope-open me-1"></i>Ler
                        </button>
                        <button class="btn btn-outline-secondary" onclick="bulkMarkUnread()">
                            <i class="fas fa-envelope me-1"></i>Não Lidas
                        </button>
                        <button class="btn btn-outline-warning" onclick="bulkArchive()">
                            <i class="fas fa-archive me-1"></i>Arquivar
                        </button>
                        <button class="btn btn-outline-danger" onclick="bulkDelete()">
                            <i class="fas fa-trash-alt me-1"></i>Excluir
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle message-list">
                        <thead>
                            <tr>
                                <th style="width: 3%;" class="text-center">
                                    <input type="checkbox" class="form-check-input" id="select-all-checkbox" onchange="toggleSelectAll(this)">
                                </th>
                                <th style="width: 5%;" class="text-center" aria-label="Status"></th>
                                <th style="width: 22%;">Remetente</th>
                                <th>Assunto</th>
                                <th style="width: 12%;" class="text-end">Data</th>
                                <th style="width: 12%;" class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Message Modal -->
<div class="modal fade" id="viewMessageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewMessageTitle">
                    <i class="fas fa-envelope-open me-2"></i>
                    Carregando...
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="message-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <div id="message-content" style="display: none;">
                    <div class="mb-3">
                        <strong>De:</strong> <span id="msg-sender"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Para:</strong> <span id="msg-recipient"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Data:</strong> <span id="msg-date"></span>
                    </div>
                    <div class="mb-3" id="msg-attachments-container" style="display: none;">
                        <strong>Anexos:</strong>
                        <div id="msg-attachments"></div>
                    </div>
                    <hr>
                    <div id="msg-body" style="max-height: 500px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="replyFromView()">
                    <i class="fas fa-reply me-1"></i>
                    Responder
                </button>
                <button type="button" class="btn btn-warning" onclick="archiveFromView()">
                    <i class="fas fa-archive me-1"></i>
                    Arquivar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i>
                    Responder: <span id="reply-subject"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reply-form">
                    <div class="mb-3">
                        <label class="form-label">Para: <span id="reply-to"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="reply-body" class="form-label">Mensagem:</label>
                        <textarea class="form-control" id="reply-body" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sendReply()">
                    <i class="fas fa-paper-plane me-1"></i>
                    Enviar Resposta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Send Email Modal -->
<div class="modal fade" id="sendEmailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar Email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="send-email-form">
                    <div class="mb-3">
                        <label for="email-to" class="form-label">Para:</label>
                        <input type="email" class="form-control" id="email-to" required>
                    </div>
                    <div class="mb-3">
                        <label for="email-subject" class="form-label">Assunto:</label>
                        <input type="text" class="form-control" id="email-subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="email-body" class="form-label">Mensagem:</label>
                        <textarea class="form-control" id="email-body" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sendEmail()">
                    <i class="fas fa-paper-plane me-1"></i>
                    Enviar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const QUICK_FILTERS = {
    all: '',
    unread: 'in:inbox is:unread',
    starred: 'in:inbox is:starred',
    important: 'in:inbox is:important',
    sent: 'in:sent'
};

const HIDDEN_LABEL_IDS = new Set(['INBOX', 'CATEGORY_PERSONAL', 'CATEGORY_PRIMARY', 'UNREAD', 'STARRED', 'IMPORTANT', 'SENT']);
const SYSTEM_LABEL_NAMES = {
    STARRED: 'Com estrela',
    IMPORTANT: 'Importante',
    SENT: 'Enviados',
    DRAFT: 'Rascunhos',
    TRASH: 'Lixeira',
    SPAM: 'Spam',
    CATEGORY_PRIMARY: 'Principal',
    CATEGORY_SOCIAL: 'Social',
    CATEGORY_PROMOTIONS: 'Promoções',
    CATEGORY_UPDATES: 'Atualizações',
    CATEGORY_FORUMS: 'Fóruns'
};

const numberFormatter = new Intl.NumberFormat('pt-BR');

function formatNumber(value) {
    const numericValue = typeof value === 'number' ? value : parseInt(value || '0', 10);
    if (Number.isNaN(numericValue)) {
        return '0';
    }
    return numberFormatter.format(numericValue);
}

const selectedMessages = new Set();

let currentMessages = [];
let nextPageToken = null;
let currentQuery = '';
let desiredMaxResults = 25;
let messagesLoaded = 0;
let isLoadingMessages = false;
let totalEstimate = 0;
let activeQuickFilter = 'unread';

document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    // Inicia com filtro de não lidas
    setQuickFilter('unread');
});

function loadStats() {
    // Carrega contagem de não lidas
    fetch('/api/gmail/unread-count')
        .then(response => response.json())
        .then(data => {
            // A API retorna {status: 'success', data: {count: X}}
            const count = (data.data && data.data.count) || 0;
            document.getElementById('unread-count').textContent = formatNumber(count);
        })
        .catch(error => console.error('Erro ao carregar não lidas:', error));

    // Carrega labels
    fetch('/api/gmail/labels')
        .then(response => response.json())
        .then(data => {
            // A API retorna {status: 'success', data: {labels: [...]}}
            const labels = (data.data && data.data.labels) || [];
            const labelsCountEl = document.getElementById('labels-count');
            if (labelsCountEl) {
                labelsCountEl.textContent = formatNumber(labels.length);
            }

            const sentLabel = labels.find(label => label.id === 'SENT');
            const sentCountEl = document.getElementById('sent-count');
            const sentCard = document.getElementById('sent-card');

            const sentTotal = sentLabel && typeof sentLabel.messages_total === 'number'
                ? sentLabel.messages_total
                : 0;

            if (sentCountEl) {
                sentCountEl.textContent = formatNumber(sentTotal);
            }

            if (sentCard) {
                const colorData = sentLabel && sentLabel.color ? sentLabel.color : {};
                const background = colorData.backgroundColor || 'var(--success-color)';
                const textColor = colorData.textColor || '#ffffff';

                sentCard.style.background = background;
                sentCard.style.color = textColor;

                sentCard.querySelectorAll('.card-text, .card-title, i').forEach(el => {
                    el.style.color = textColor;
                });
            }
        })
        .catch(error => console.error('Erro ao carregar labels:', error));
}

function getLoadingRow() {
    return '<tr class="loading-row"><td colspan="6" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></td></tr>';
}

function showLoadingRow(append = false) {
    const tbody = document.getElementById('messages-table');
    if (!tbody) return;

    if (append && tbody.children.length > 0) {
        if (!tbody.querySelector('tr.loading-row')) {
            tbody.insertAdjacentHTML('beforeend', getLoadingRow());
        }
    } else if (!append) {
        tbody.innerHTML = getLoadingRow();
    }
}

function hideLoadingRow() {
    const tbody = document.getElementById('messages-table');
    if (!tbody) return;
    const loader = tbody.querySelector('tr.loading-row');
    if (loader) {
        loader.remove();
    }
}

function refreshMessages() {
    currentQuery = document.getElementById('search-query').value;

    // Se a busca foi disparada manualmente, remove destaque de filtros rápidos
    if (!Object.values(QUICK_FILTERS).includes(currentQuery)) {
        clearQuickFilterHighlight();
        activeQuickFilter = null;
    }
    desiredMaxResults = parseInt(document.getElementById('max-results').value, 10);
    desiredMaxResults = Number.isNaN(desiredMaxResults) ? 10 : desiredMaxResults;
    currentMessages = [];
    nextPageToken = null;
    messagesLoaded = 0;
    totalEstimate = 0;
    selectedMessages.clear();
    updateBulkActions();

    console.log('Buscando mensagens...', { query: currentQuery, desiredMaxResults });

    showLoadingRow(false);

    const initialBatchSize = Math.min(10, desiredMaxResults);
    fetchMessagesBatch(initialBatchSize, false, null)
        .then(() => {
            if (nextPageToken && messagesLoaded < desiredMaxResults) {
                return loadRemainingMessages();
            }
            return null;
        });
}

function fetchMessagesBatch(pageSize, append, pageToken) {
    if (isLoadingMessages) {
        return Promise.resolve();
    }

    const effectiveSize = Math.min(Math.max(pageSize || desiredMaxResults, 1), 100);
    isLoadingMessages = true;

    if (append) {
        showLoadingRow(true);
    }

    const params = new URLSearchParams({
        query: currentQuery,
        max_results: effectiveSize.toString(),
        _: Date.now().toString()
    });

    if (pageToken) {
        params.append('page_token', pageToken);
    }

    return fetch(`/api/gmail/messages?${params.toString()}`, {
        cache: 'no-cache',
        headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error || data.status === 'error') {
                throw new Error(data.error || data.message || 'Erro desconhecido');
            }

            const payload = data.data || {};
            const receivedMessages = payload.messages || [];
            if (typeof payload.estimated_total === 'number') {
                totalEstimate = payload.estimated_total;
            }
            nextPageToken = payload.next_page_token || null;

            const updatedList = append ? [...currentMessages] : [];
            const seenIds = new Set(updatedList.map(msg => msg.id));

            for (const msg of receivedMessages) {
                if (updatedList.length >= desiredMaxResults) {
                    break;
                }
                if (!seenIds.has(msg.id)) {
                    updatedList.push(msg);
                    seenIds.add(msg.id);
                }
            }

            currentMessages = updatedList;
            messagesLoaded = currentMessages.length;
            totalEstimate = Math.max(totalEstimate, messagesLoaded);

            if (messagesLoaded >= desiredMaxResults) {
                nextPageToken = messagesLoaded === desiredMaxResults ? nextPageToken : null;
            }

            console.log('Mensagens processadas:', currentMessages.length, 'nextPageToken:', nextPageToken);
            displayMessages(currentMessages);
            updateStats();
        })
        .catch(error => {
            console.error('Erro ao carregar mensagens:', error);
            showAlert('Erro ao carregar mensagens: ' + error.message, 'danger');
            if (!append) {
                const tbody = document.getElementById('messages-table');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar mensagens</td></tr>';
                }
            }
            selectedMessages.clear();
            updateBulkActions();
        })
        .finally(() => {
            isLoadingMessages = false;
            hideLoadingRow();
        });
}

function loadRemainingMessages() {
    if (!nextPageToken || isLoadingMessages || messagesLoaded >= desiredMaxResults) {
        return Promise.resolve();
    }

    const remaining = desiredMaxResults - messagesLoaded;
    if (remaining <= 0) {
        return Promise.resolve();
    }

    const nextBatchSize = Math.min(remaining, 100);
    return fetchMessagesBatch(nextBatchSize, true, nextPageToken)
        .then(() => {
            if (nextPageToken && messagesLoaded < desiredMaxResults) {
                return loadRemainingMessages();
            }
            return null;
        });
}

function searchMessages() {
    currentQuery = document.getElementById('search-query').value;
    activeQuickFilter = null;
    clearQuickFilterHighlight();
    refreshMessages();
}

function renderLabelChips(labels) {
    if (!Array.isArray(labels) || labels.length === 0) {
        return '';
    }

    const seen = new Set();
    const chips = [];

    labels.forEach(label => {
        if (!label || !label.id) {
            return;
        }
        if (seen.has(label.id) || HIDDEN_LABEL_IDS.has(label.id)) {
            return;
        }
        seen.add(label.id);

        const displayName = SYSTEM_LABEL_NAMES[label.id] || label.name || label.id;
        const background = label.background_color || (label.type === 'system' ? 'rgba(66, 133, 244, 0.12)' : 'rgba(0, 0, 0, 0.08)');
        const textColor = label.text_color || (label.type === 'system' ? '#1a73e8' : '#202124');

        chips.push(`<span class="label-chip" style="background:${background}; color:${textColor};">${escapeHtml(displayName)}</span>`);
    });

    return chips.join('');
}

function toggleMessageSelection(checkbox, messageId) {
    if (checkbox.checked) {
        selectedMessages.add(messageId);
    } else {
        selectedMessages.delete(messageId);
    }
    updateBulkActions();
}

function toggleSelectAll(masterCheckbox) {
    if (masterCheckbox.checked) {
        currentMessages.forEach(msg => selectedMessages.add(msg.id));
    } else {
        currentMessages.forEach(msg => selectedMessages.delete(msg.id));
    }
    displayMessages(currentMessages);
}

function syncSelectAllState() {
    const selectAll = document.getElementById('select-all-checkbox');
    if (!selectAll) return;

    const totalVisible = currentMessages.length;
    let selectedVisible = 0;
    currentMessages.forEach(msg => {
        if (selectedMessages.has(msg.id)) {
            selectedVisible += 1;
        }
    });

    if (totalVisible === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        return;
    }

    selectAll.checked = selectedVisible === totalVisible;
    selectAll.indeterminate = selectedVisible > 0 && selectedVisible < totalVisible;
}

function updateBulkActions() {
    const bar = document.getElementById('bulk-actions');
    if (!bar) return;

    const count = selectedMessages.size;
    const countElement = document.getElementById('bulk-count');
    if (countElement) {
        countElement.textContent = count;
    }

    bar.style.display = count > 0 ? 'flex' : 'none';
    syncSelectAllState();
}

function bulkArchive() {
    performBulkAction('archive');
}

function bulkDelete() {
    if (selectedMessages.size === 0) {
        showAlert('Selecione pelo menos uma mensagem.', 'warning');
        return;
    }
    if (confirm('Deseja realmente excluir as mensagens selecionadas? Esta ação não pode ser desfeita.')) {
        performBulkAction('delete');
    }
}

function bulkMarkRead() {
    performBulkAction('mark_read');
}

function bulkMarkUnread() {
    performBulkAction('mark_unread');
}

function performBulkAction(action) {
    if (selectedMessages.size === 0) {
        showAlert('Selecione pelo menos uma mensagem.', 'warning');
        return;
    }

    const ids = Array.from(selectedMessages);
    fetch('/api/gmail/messages/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action, ids })
    })
        .then(response => response.json())
        .then(data => {
            if (data.error || data.status === 'error') {
                throw new Error(data.error || data.message || 'Falha ao executar ação em lote');
            }

            const payload = data.data || {};
            const processedIds = payload.processed || ids;
            const processedSet = new Set(processedIds);
            const actionType = payload.action || action;
            const successMessage = payload.message || 'Ação concluída com sucesso!';

            processedIds.forEach(id => selectedMessages.delete(id));

            if (actionType === 'archive' || actionType === 'delete') {
                currentMessages = currentMessages.filter(msg => !processedSet.has(msg.id));
                messagesLoaded = currentMessages.length;
                totalEstimate = Math.max(0, totalEstimate - processedIds.length);
                displayMessages(currentMessages);
                updateStats();
                if (nextPageToken && messagesLoaded < desiredMaxResults) {
                    loadRemainingMessages();
                }
            } else if (actionType === 'mark_read' || actionType === 'mark_unread') {
                const shouldBeUnread = actionType === 'mark_unread';
                currentMessages.forEach(msg => {
                    if (processedSet.has(msg.id)) {
                        msg.unread = shouldBeUnread;
                        if (shouldBeUnread) {
                            if (Array.isArray(msg.label_ids)) {
                                if (!msg.label_ids.includes('UNREAD')) {
                                    msg.label_ids.push('UNREAD');
                                }
                            } else {
                                msg.label_ids = ['UNREAD'];
                            }
                        } else if (Array.isArray(msg.label_ids)) {
                            msg.label_ids = msg.label_ids.filter(id => id !== 'UNREAD');
                        }
                        if (!shouldBeUnread && Array.isArray(msg.labels)) {
                            msg.labels = msg.labels.filter(label => label.id !== 'UNREAD');
                        }
                    }
                });
                displayMessages(currentMessages);
                updateStats();
            } else {
                displayMessages(currentMessages);
            }

            loadStats();
            showAlert(successMessage, 'success');
        })
        .catch(error => {
            console.error('Erro em operação em lote:', error);
            showAlert('Erro ao executar ação em lote: ' + error.message, 'danger');
            updateBulkActions();
        });
}


function displayMessages(messages) {
    console.log('displayMessages chamado com:', messages.length, 'mensagens');
    const tbody = document.getElementById('messages-table');

    if (!tbody) {
        console.error('Elemento messages-table não encontrado!');
        return;
    }

    if (messages.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma mensagem encontrada</td></tr>';
        updateBulkActions();
        return;
    }

    tbody.innerHTML = messages.map(msg => {
        const isSelected = selectedMessages.has(msg.id);
        const isUnread = Boolean(msg.unread);
        const dateStr = formatMessageDate(msg.date);

        const statusIcons = [];
        if (msg.starred) {
            statusIcons.push('<i class="fas fa-star text-warning" title="Com estrela"></i>');
        }
        if (msg.important) {
            statusIcons.push('<i class="fas fa-exclamation text-danger" title="Importante"></i>');
        }
        if (isUnread) {
            statusIcons.push('<i class="fas fa-circle text-primary" title="Não lida"></i>');
        }

        const statusIconsHtml = statusIcons.length ? statusIcons.join(' ') : '&nbsp;';
        const subjectText = escapeHtml(msg.subject || 'Sem assunto');
        const rawSnippet = msg.snippet || '';
        const snippetText = rawSnippet
            ? escapeHtml(rawSnippet.length > 110 ? `${rawSnippet.substring(0, 107)}...` : rawSnippet)
            : '';
        const labelsHtml = renderLabelChips(msg.labels || []);
        const labelsInline = labelsHtml ? `<span class="thread-labels">${labelsHtml}</span>` : '';
        const senderTitle = escapeHtml(msg.sender || 'Desconhecido');
        const senderShort = escapeHtml(truncateSender(msg.sender || 'Desconhecido'));
        const senderClass = `thread-sender${isUnread ? ' unread' : ''}`;
        const subjectClass = `thread-subject${isUnread ? ' unread' : ''}`;
        const snippetHtml = snippetText ? `<span class="thread-snippet">${snippetText}</span>` : '';
        const rowClasses = [
            isUnread ? 'fw-bold' : '',
            isSelected ? 'selected' : ''
        ].filter(Boolean).join(' ');

        return `
        <tr class="${rowClasses}">
            <td class="text-center">
                <input type="checkbox" class="form-check-input message-checkbox" onchange="toggleMessageSelection(this, '${msg.id}')" ${isSelected ? 'checked' : ''}>
            </td>
            <td class="text-center">
                ${statusIconsHtml}
            </td>
            <td>
                <span class="${senderClass}" title="${senderTitle}">${senderShort}</span>
            </td>
            <td>
                <div class="thread-meta">
                    <span class="${subjectClass}">${subjectText}</span>
                    ${labelsInline}
                    ${snippetHtml}
                </div>
            </td>
            <td class="text-end">
                <span class="thread-date">${dateStr}</span>
            </td>
            <td class="text-end">
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="viewMessage('${msg.id}')" title="Ver">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="replyMessage('${msg.id}')" title="Responder">
                        <i class="fas fa-reply"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="archiveMessage('${msg.id}')" title="Arquivar">
                        <i class="fas fa-archive"></i>
                    </button>
                    ${isUnread ?
                        `<button class="btn btn-outline-secondary" onclick="markAsRead('${msg.id}')" title="Marcar como lida">
                            <i class="fas fa-check"></i>
                        </button>` :
                        `<button class="btn btn-outline-secondary" onclick="markAsUnread('${msg.id}')" title="Marcar como não lida">
                            <i class="fas fa-envelope"></i>
                        </button>`
                    }
                </div>
            </td>
        </tr>
    `;
    }).join('');
    console.log('Tabela atualizada com sucesso!');
    updateBulkActions();
}

function removeMessageLocally(messageId) {
    const originalLength = currentMessages.length;
    selectedMessages.delete(messageId);
    currentMessages = currentMessages.filter(msg => msg.id !== messageId);

    if (currentMessages.length !== originalLength) {
        messagesLoaded = currentMessages.length;
        if (totalEstimate > 0) {
            totalEstimate = Math.max(messagesLoaded, totalEstimate - 1);
        }
        displayMessages(currentMessages);
        updateStats();
        updateBulkActions();
        return true;
    }
    return false;
}

function updateStats() {
    const totalElement = document.getElementById('total-messages');
    if (totalElement) {
        const totalValue = totalEstimate > 0 ? Math.max(totalEstimate, currentMessages.length) : currentMessages.length;
        totalElement.textContent = formatNumber(totalValue);
    }

    const unreadCount = currentMessages.filter(msg => msg.unread).length;
    const unreadElement = document.getElementById('unread-count');
    if (unreadElement) {
        unreadElement.textContent = formatNumber(unreadCount);
    }
}

let currentViewingMessage = null;

function viewMessage(messageId) {
    console.log('Visualizando mensagem:', messageId);

    // Mostra o modal
    const modal = new bootstrap.Modal(document.getElementById('viewMessageModal'));
    modal.show();

    // Reseta o conteúdo
    document.getElementById('message-loading').style.display = 'block';
    document.getElementById('message-content').style.display = 'none';
    document.getElementById('viewMessageTitle').innerHTML = '<i class="fas fa-envelope-open me-2"></i>Carregando...';

    // Busca detalhes da mensagem
    const timestamp = new Date().getTime();
    fetch(`/api/gmail/message/${messageId}?_=${timestamp}`, {
        cache: 'no-cache'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || data.status === 'error') {
            showAlert('Erro ao carregar mensagem: ' + (data.error || data.message), 'danger');
            modal.hide();
            return;
        }

        const msg = data.data.message;
        currentViewingMessage = msg;

        // Atualiza o modal com os dados
        document.getElementById('viewMessageTitle').innerHTML = `<i class="fas fa-envelope-open me-2"></i>${msg.subject || 'Sem assunto'}`;
        document.getElementById('msg-sender').textContent = msg.sender || 'Desconhecido';
        document.getElementById('msg-recipient').textContent = msg.recipient || 'Desconhecido';
        document.getElementById('msg-date').textContent = msg.date || 'Data não disponível';

        // Renderiza o corpo (HTML ou texto)
        const bodyElement = document.getElementById('msg-body');
        const body = msg.body || 'Corpo da mensagem não disponível';

        // Detecta se é HTML
        if (body.trim().startsWith('<') || body.includes('<html>') || body.includes('<body>')) {
            // Renderiza como HTML em um iframe seguro
            bodyElement.innerHTML = `<iframe
                srcdoc="${body.replace(/"/g, '&quot;')}"
                style="width: 100%; min-height: 400px; border: none;"
                sandbox="allow-same-origin">
            </iframe>`;
        } else {
            // Renderiza como texto puro com formatação
            bodyElement.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${escapeHtml(body)}</pre>`;
        }

        // Exibe anexos se houver
        if (msg.attachments && msg.attachments.length > 0) {
            const attachmentsHtml = msg.attachments.map(att =>
                `<div class="badge bg-secondary me-2">
                    <i class="fas fa-paperclip me-1"></i>${att.filename}
                </div>`
            ).join('');
            document.getElementById('msg-attachments').innerHTML = attachmentsHtml;
            document.getElementById('msg-attachments-container').style.display = 'block';
        } else {
            document.getElementById('msg-attachments-container').style.display = 'none';
        }

        // Esconde loading e mostra conteúdo
        document.getElementById('message-loading').style.display = 'none';
        document.getElementById('message-content').style.display = 'block';
    })
    .catch(error => {
        console.error('Erro ao carregar mensagem:', error);
        showAlert('Erro ao carregar mensagem: ' + error.message, 'danger');
        modal.hide();
    });
}

function replyMessage(messageId) {
    console.log('Preparando resposta para:', messageId);

    // Busca a mensagem da lista atual
    const message = currentMessages.find(m => m.id === messageId);
    if (!message) {
        showAlert('Mensagem não encontrada', 'warning');
        return;
    }

    // Armazena o ID para uso posterior
    window.currentReplyMessageId = messageId;

    // Preenche o modal de resposta
    document.getElementById('reply-subject').textContent = message.subject || 'Sem assunto';
    document.getElementById('reply-to').textContent = message.sender || 'Desconhecido';
    document.getElementById('reply-body').value = '';

    // Mostra o modal
    const modal = new bootstrap.Modal(document.getElementById('replyModal'));
    modal.show();
}

function replyFromView() {
    if (!currentViewingMessage) return;

    // Fecha o modal de visualização
    bootstrap.Modal.getInstance(document.getElementById('viewMessageModal')).hide();

    // Abre o modal de resposta
    setTimeout(() => {
        window.currentReplyMessageId = currentViewingMessage.id;
        document.getElementById('reply-subject').textContent = currentViewingMessage.subject || 'Sem assunto';
        document.getElementById('reply-to').textContent = currentViewingMessage.sender || 'Desconhecido';
        document.getElementById('reply-body').value = '';

        const modal = new bootstrap.Modal(document.getElementById('replyModal'));
        modal.show();
    }, 300);
}

function sendReply() {
    const replyText = document.getElementById('reply-body').value;

    if (!replyText.trim()) {
        showAlert('Digite uma mensagem para responder', 'warning');
        return;
    }

    if (!window.currentReplyMessageId) {
        showAlert('ID da mensagem não encontrado', 'error');
        return;
    }

    console.log('Enviando resposta...');

    fetch(`/api/gmail/message/${window.currentReplyMessageId}/reply`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ reply_text: replyText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || data.status === 'error') {
            showAlert('Erro ao enviar resposta: ' + (data.error || data.message), 'danger');
        } else {
            showAlert('Resposta enviada com sucesso!', 'success');
            document.getElementById('reply-form').reset();
            bootstrap.Modal.getInstance(document.getElementById('replyModal')).hide();
            refreshMessages();
        }
    })
    .catch(error => {
        console.error('Erro ao enviar resposta:', error);
        showAlert('Erro ao enviar resposta: ' + error.message, 'danger');
    });
}

function archiveFromView() {
    if (!currentViewingMessage) return;

    if (confirm('Deseja arquivar esta mensagem?')) {
        archiveMessage(currentViewingMessage.id);
        bootstrap.Modal.getInstance(document.getElementById('viewMessageModal')).hide();
    }
}

function archiveMessage(messageId) {
    console.log('Arquivando mensagem:', messageId);

    fetch(`/api/gmail/message/${messageId}/archive`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || data.status === 'error') {
            showAlert('Erro ao arquivar: ' + (data.error || data.message), 'danger');
        } else {
            showAlert('Mensagem arquivada com sucesso!', 'success');
            const removed = removeMessageLocally(messageId);
            if (nextPageToken && messagesLoaded < desiredMaxResults) {
                loadRemainingMessages();
            } else if (!removed) {
                refreshMessages();
            }
            loadStats();
        }
    })
    .catch(error => {
        console.error('Erro ao arquivar:', error);
        showAlert('Erro ao arquivar: ' + error.message, 'danger');
    });
}

function sendEmail() {
    const to = document.getElementById('email-to').value;
    const subject = document.getElementById('email-subject').value;
    const body = document.getElementById('email-body').value;

    if (!to || !subject || !body) {
        showAlert('Preencha todos os campos', 'warning');
        return;
    }

    fetch('/api/gmail/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ to, subject, body })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || data.status === 'error') {
            showAlert('Erro ao enviar email: ' + (data.error || data.message), 'danger');
        } else {
            showAlert('Email enviado com sucesso!', 'success');
            document.getElementById('send-email-form').reset();
            bootstrap.Modal.getInstance(document.getElementById('sendEmailModal')).hide();
            // Atualiza a lista de mensagens
            refreshMessages();
        }
    })
    .catch(error => {
        console.error('Erro ao enviar email:', error);
        showAlert('Erro ao enviar email', 'danger');
    });
}

function clearQuickFilterHighlight() {
    document.querySelectorAll('.btn-group [data-filter-key]').forEach(btn => {
        btn.classList.remove('active');
    });
}

function setQuickFilter(filterKey) {
    activeQuickFilter = filterKey;
    clearQuickFilterHighlight();
    const filterButton = document.querySelector(`[data-filter-key="${filterKey}"]`);
    if (filterButton) {
        filterButton.classList.add('active');
    }

    const query = QUICK_FILTERS[filterKey] ?? '';
    document.getElementById('search-query').value = query;
    currentQuery = query;
    refreshMessages();
}

function clearSearch() {
    document.getElementById('search-query').value = '';
    setQuickFilter('all');
}

function formatMessageDate(dateStr) {
    if (!dateStr) return 'Data indisponível';

    try {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffHours < 1) {
            const diffMins = Math.floor(diffMs / (1000 * 60));
            return `${diffMins} min atrás`;
        } else if (diffHours < 24) {
            return `${diffHours}h atrás`;
        } else if (diffDays === 1) {
            return 'Ontem';
        } else if (diffDays < 7) {
            return `${diffDays} dias atrás`;
        } else {
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
    } catch (e) {
        return dateStr;
    }
}

function truncateSender(sender) {
    if (!sender) return 'Desconhecido';
    // Remove email, mantém apenas o nome
    const nameMatch = sender.match(/^([^<]+)/);
    if (nameMatch) {
        const name = nameMatch[1].trim();
        return name.length > 25 ? name.substring(0, 22) + '...' : name;
    }
    return sender.length > 25 ? sender.substring(0, 22) + '...' : sender;
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function markAsRead(messageId) {
    console.log('Marcando como lida:', messageId);

    fetch(`/api/gmail/message/${messageId}/mark-read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || data.status === 'error') {
            showAlert('Erro ao marcar como lida: ' + (data.error || data.message), 'danger');
        } else {
            showAlert('Marcada como lida!', 'success');
            // Atualiza a mensagem na lista atual
            const msgIndex = currentMessages.findIndex(m => m.id === messageId);
            if (msgIndex !== -1) {
                const message = currentMessages[msgIndex];
                message.unread = false;
                if (Array.isArray(message.label_ids)) {
                    message.label_ids = message.label_ids.filter(id => id !== 'UNREAD');
                }
                if (Array.isArray(message.labels)) {
                    message.labels = message.labels.filter(label => label.id !== 'UNREAD');
                }
                selectedMessages.delete(messageId);
                displayMessages(currentMessages);
                updateStats();
            }
            // Atualiza stats
            loadStats();
        }
    })
    .catch(error => {
        console.error('Erro ao marcar como lida:', error);
        showAlert('Erro ao marcar como lida: ' + error.message, 'danger');
    });
}

function markAsUnread(messageId) {
    console.log('Marcando como não lida:', messageId);

    fetch(`/api/gmail/message/${messageId}/mark-unread`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error || data.status === 'error') {
            showAlert('Erro ao marcar como não lida: ' + (data.error || data.message), 'danger');
        } else {
            showAlert('Marcada como não lida!', 'success');
            // Atualiza a mensagem na lista atual
            const msgIndex = currentMessages.findIndex(m => m.id === messageId);
            if (msgIndex !== -1) {
                const message = currentMessages[msgIndex];
                message.unread = true;
                if (Array.isArray(message.label_ids)) {
                    if (!message.label_ids.includes('UNREAD')) {
                        message.label_ids.push('UNREAD');
                    }
                } else {
                    message.label_ids = ['UNREAD'];
                }
                selectedMessages.delete(messageId);
                displayMessages(currentMessages);
                updateStats();
            }
            // Atualiza stats
            loadStats();
        }
    })
    .catch(error => {
        console.error('Erro ao marcar como não lida:', error);
        showAlert('Erro ao marcar como não lida: ' + error.message, 'danger');
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Remove o alerta após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>
{% endblock %}
